import{u as E,r as i,f as w,g as x,A as k,a as I,j as o}from"./index-BHm97sXj.js";import{o as P,s as N,u as F,t as C,F as L,T as v}from"./types-lczcgCYJ.js";import{C as j}from"./Card-f3ypaRXl.js";import{B as y}from"./Button-Dxd6S_NP.js";import{P as S}from"./PageLayout-DWmY_Bl_.js";function A(){const{isAuthenticated:s,refreshUser:e}=E(),[t,n]=i.useState({firstName:"",lastName:"",ssn:""}),[f,m]=i.useState(!0),[h,r]=i.useState(!1),[l,c]=i.useState(null),a=i.useCallback(async()=>{m(!0),c(null);try{if(!s){m(!1);return}const u=await w("/user/me");n({firstName:u.firstName??"",lastName:u.lastName??"",ssn:u.ssn??""})}catch(u){c(x(u,"Klarte ikke å hente brukerdata."))}finally{m(!1)}},[s]);i.useEffect(()=>{a()},[a]);const g=i.useCallback(async u=>{const d={firstName:u.firstName.trim(),lastName:u.lastName.trim(),ssn:u.ssn.trim()};if(!d.firstName||!d.lastName||!d.ssn)throw new k("Fyll inn alle feltene før du lagrer.",400);r(!0),c(null);try{await w("/user/me",{method:"PUT",body:d}),n(d),await e()}catch(b){throw c(x(b,"Kunne ikke lagre informasjon.")),b}finally{r(!1)}},[e]),p=i.useMemo(()=>!t.firstName.trim()||!t.lastName.trim()||!t.ssn.trim(),[t.firstName,t.lastName,t.ssn]);return{profile:t,isLoading:f,isSaving:h,error:l,needsInfo:p,saveProfile:g,refresh:a}}function U(s){const t=(s.headers.get("Content-Disposition")??"").match(/filename\*=UTF-8''(.+)|filename="?([^";]+)"?/i);if(!t)return"insurance_request.xml";const[,n,f]=t;if(n)try{return decodeURIComponent(n)}catch{return n}return f??"insurance_request.xml"}function T(s,e){const t=window.URL.createObjectURL(s),n=document.createElement("a");n.href=t,n.download=e,document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(t)}function R(){const{isAuthenticated:s,token:e}=E(),[t,n]=i.useState(!1),[f,m]=i.useState(null),h=i.useCallback(async()=>{B(s,e),n(!0),m(null);try{const r=await fetch(`${I}/insurance/send`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(!r.ok){const a=await M(r);throw new k(a,r.status)}const l=await r.blob(),c=U(r);return T(l,c),"Forsikringssøknad generert og lastet ned."}catch(r){const l=x(r);throw m(l),r instanceof Error?r:new k(l,500)}finally{n(!1)}},[s,e]);return{isSending:t,error:f,sendInsurance:h}}function B(s,e){if(!s||!e)throw new k("Du må være innlogget for å sende søknaden.",401)}async function M(s){try{const e=await s.json();if(e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")return e.message}catch{}try{const e=await s.text();if(e)return e}catch{}return`Request failed with status ${s.status}`}const q=P({firstName:N().min(1,"Fornavn er påkrevd"),lastName:N().min(1,"Etternavn er påkrevd"),ssn:N().regex(/^\d{11}$/,"Fødselsnummer må være 11 siffer")});function K(){const{profile:s,isLoading:e,isSaving:t,error:n,needsInfo:f,saveProfile:m}=A(),{isSending:h,error:r,sendInsurance:l}=R(),[c,a]=i.useState(null),g=F({resolver:C(q),defaultValues:{firstName:s.firstName,lastName:s.lastName,ssn:s.ssn},mode:"onTouched"});i.useEffect(()=>{g.reset({firstName:s.firstName,lastName:s.lastName,ssn:s.ssn})},[g,s]),i.useEffect(()=>{n&&a({variant:"error",message:n})},[n]),i.useEffect(()=>{r&&a({variant:"error",message:r})},[r]);const p=i.useMemo(()=>g.handleSubmit(async d=>{a(null);try{await m(d),a({variant:"success",message:"Informasjon lagret. Du kan nå sende søknaden."})}catch(b){a({variant:"error",message:x(b,"Klarte ikke å lagre informasjon. Prøv igjen.")})}}),[g,m]),u=i.useCallback(async()=>{a(null);try{const d=await l();a({variant:"success",message:d})}catch(d){a({variant:"error",message:x(d,"Kunne ikke generere forsikringssøknad.")})}},[l]);return{form:g,banner:c,isLoading:e,isSaving:t,isSending:h,needsInfo:f,onSaveProfile:p,onSendInsurance:u}}function W(){var a,g,p;const{form:s,banner:e,isLoading:t,isSaving:n,isSending:f,needsInfo:m,onSaveProfile:h,onSendInsurance:r}=K(),{register:l,formState:{errors:c}}=s;return t?o.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Henter informasjon ...",maxWidthClassName:"max-w-4xl",children:o.jsx("div",{className:"text-center text-slate-700",children:"Laster ..."})}):o.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Send inn opplysningene dine og få beregnet dekningen som passer planen din.",maxWidthClassName:"max-w-4xl",actions:o.jsx(y,{to:"/plan",className:"bg-white text-emerald-700 border-emerald-200 hover:bg-emerald-50 font-semibold",children:"Tilbake til plan"}),children:o.jsxs("div",{className:"space-y-6",children:[e&&o.jsx(L,{variant:e.variant,message:e.message,action:e.action}),m&&o.jsxs(j,{title:"Fyll ut manglende opplysninger",children:[o.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"For å sende inn forsikringssøkaden må vi vite hvem du er."}),o.jsxs("form",{onSubmit:h,className:"flex flex-col gap-4",children:[o.jsx(v,{label:"Fornavn",placeholder:"Fornavn",error:(a=c.firstName)==null?void 0:a.message,autoComplete:"given-name",...l("firstName")}),o.jsx(v,{label:"Etternavn",placeholder:"Etternavn",error:(g=c.lastName)==null?void 0:g.message,autoComplete:"family-name",...l("lastName")}),o.jsx(v,{label:"Fødselsnummer",placeholder:"Fødselsnummer (11 siffer)",error:(p=c.ssn)==null?void 0:p.message,inputMode:"numeric",autoComplete:"off",...l("ssn")}),o.jsx(y,{type:"submit",disabled:n,children:n?"Lagrer...":"Lagre informasjon"})]})]}),o.jsxs(j,{title:"Send inn søknad",children:[o.jsx("p",{className:"text-sm text-slate-700 mb-4",children:"Vi bruker planen din og opplysningene over til å beregne dekning. Når du sender inn, får du bekreftelse på e-post."}),o.jsx(y,{type:"button",onClick:r,disabled:f,children:f?"Sender...":"Send søknad"})]})]})})}export{W as default};
