import{u as E,r as a,f as w,g as p,A as b,b as I,j as i}from"./index-IST0QHVW.js";import{o as P,s as N,u as F,t as C,F as L,T as v}from"./types-CUtUjmsB.js";import{C as j}from"./Card-BoiwNR6c.js";import{B as y}from"./Button-BIXv3_rL.js";import{P as S}from"./PageLayout-BE_FrvBE.js";function A(){const{isAuthenticated:s,refreshUser:e}=E(),[t,n]=a.useState({firstName:"",lastName:"",ssn:""}),[f,m]=a.useState(!0),[g,r]=a.useState(!1),[l,c]=a.useState(null),o=a.useCallback(async()=>{m(!0),c(null);try{if(!s){m(!1);return}const u=await w("/user/me");n({firstName:u.firstName??"",lastName:u.lastName??"",ssn:u.ssn??""})}catch(u){c(p(u,"Klarte ikke å hente brukerdata."))}finally{m(!1)}},[s]);a.useEffect(()=>{o()},[o]);const h=a.useCallback(async u=>{const d={firstName:u.firstName.trim(),lastName:u.lastName.trim(),ssn:u.ssn.trim()};if(!d.firstName||!d.lastName||!d.ssn)throw new b("Fyll inn alle feltene før du lagrer.",400);r(!0),c(null);try{await w("/user/me",{method:"PUT",body:d}),n(d),await e()}catch(x){throw c(p(x,"Kunne ikke lagre informasjon.")),x}finally{r(!1)}},[e]),k=a.useMemo(()=>!t.firstName.trim()||!t.lastName.trim()||!t.ssn.trim(),[t.firstName,t.lastName,t.ssn]);return{profile:t,isLoading:f,isSaving:g,error:l,needsInfo:k,saveProfile:h,refresh:o}}function U(s){const t=(s.headers.get("Content-Disposition")??"").match(/filename\*=UTF-8''(.+)|filename="?([^";]+)"?/i);if(!t)return"insurance_request.xml";const[,n,f]=t;if(n)try{return decodeURIComponent(n)}catch{return n}return f??"insurance_request.xml"}function T(s,e){const t=window.URL.createObjectURL(s),n=document.createElement("a");n.href=t,n.download=e,document.body.appendChild(n),n.click(),n.remove(),window.URL.revokeObjectURL(t)}function R(){const{isAuthenticated:s,token:e}=E(),[t,n]=a.useState(!1),[f,m]=a.useState(null),g=a.useCallback(async()=>{B(s,e),n(!0),m(null);try{const r=await fetch(`${I}/insurance/send`,{method:"POST",headers:{Authorization:`Bearer ${e}`}});if(!r.ok){const o=await M(r);throw new b(o,r.status)}const l=await r.blob(),c=U(r);return T(l,c),"Forsikringssøknad generert og lastet ned."}catch(r){const l=p(r);throw m(l),r instanceof Error?r:new b(l,500)}finally{n(!1)}},[s,e]);return{isSending:t,error:f,sendInsurance:g}}function B(s,e){if(!s||!e)throw new b("Du må være innlogget for å sende søknaden.",401)}async function M(s){try{const e=await s.json();if(e&&typeof e=="object"&&"message"in e&&typeof e.message=="string")return e.message}catch{}try{const e=await s.text();if(e)return e}catch{}return`Request failed with status ${s.status}`}const q=P({firstName:N().min(1,"Fornavn er påkrevd"),lastName:N().min(1,"Etternavn er påkrevd"),ssn:N().regex(/^\d{11}$/,"Fødselsnummer må være 11 siffer")});function K(){const{profile:s,isLoading:e,isSaving:t,error:n,needsInfo:f,saveProfile:m}=A(),{isSending:g,error:r,sendInsurance:l}=R(),[c,o]=a.useState(null),h=F({resolver:C(q),defaultValues:{firstName:s.firstName,lastName:s.lastName,ssn:s.ssn},mode:"onTouched"});a.useEffect(()=>{h.reset({firstName:s.firstName,lastName:s.lastName,ssn:s.ssn})},[h,s]),a.useEffect(()=>{n&&o({variant:"error",message:n})},[n]),a.useEffect(()=>{r&&o({variant:"error",message:r})},[r]);const k=a.useMemo(()=>h.handleSubmit(async d=>{o(null);try{await m(d),o({variant:"success",message:"Informasjon lagret. Du kan nå sende søknaden."})}catch(x){o({variant:"error",message:p(x,"Klarte ikke å lagre informasjon. Prøv igjen.")})}}),[h,m]),u=a.useCallback(async()=>{o(null);try{const d=await l();o({variant:"success",message:d})}catch(d){o({variant:"error",message:p(d,"Kunne ikke generere forsikringssøknad.")})}},[l]);return{form:h,banner:c,isLoading:e,isSaving:t,isSending:g,needsInfo:f,onSaveProfile:k,onSendInsurance:u}}function W(){const{form:s,banner:e,isLoading:t,isSaving:n,isSending:f,needsInfo:m,onSaveProfile:g,onSendInsurance:r}=K(),{register:l,formState:{errors:c}}=s;return t?i.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Henter informasjon ...",maxWidthClassName:"max-w-4xl",children:i.jsx("div",{className:"text-center text-slate-700",children:"Laster ..."})}):i.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Send inn opplysningene dine og få beregnet dekningen som passer planen din.",maxWidthClassName:"max-w-4xl",actions:i.jsx(y,{to:"/plan",className:"bg-white text-emerald-700 border-emerald-200 hover:bg-emerald-50 font-semibold",children:"Tilbake til plan"}),children:i.jsxs("div",{className:"space-y-6",children:[e&&i.jsx(L,{variant:e.variant,message:e.message,action:e.action}),m&&i.jsxs(j,{title:"Fyll ut manglende opplysninger",children:[i.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"For å sende inn forsikringssøkaden må vi vite hvem du er."}),i.jsxs("form",{onSubmit:g,className:"flex flex-col gap-4",children:[i.jsx(v,{label:"Fornavn",placeholder:"Fornavn",error:c.firstName?.message,autoComplete:"given-name",...l("firstName")}),i.jsx(v,{label:"Etternavn",placeholder:"Etternavn",error:c.lastName?.message,autoComplete:"family-name",...l("lastName")}),i.jsx(v,{label:"Fødselsnummer",placeholder:"Fødselsnummer (11 siffer)",error:c.ssn?.message,inputMode:"numeric",autoComplete:"off",...l("ssn")}),i.jsx(y,{type:"submit",disabled:n,children:n?"Lagrer...":"Lagre informasjon"})]})]}),i.jsxs(j,{title:"Send inn søknad",children:[i.jsx("p",{className:"text-sm text-slate-700 mb-4",children:"Vi bruker planen din og opplysningene over til å beregne dekning. Når du sender inn, får du bekreftelse på e-post."}),i.jsx(y,{type:"button",onClick:r,disabled:f,children:f?"Sender...":"Send søknad"})]})]})})}export{W as default};
