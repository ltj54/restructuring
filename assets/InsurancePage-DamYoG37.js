import{u as E,r as i,f as j,g as x,A as k,a as I,j as l}from"./index-D05Wi4Cc.js";import{o as P,s as N,u as F,t as C,F as L,T as v}from"./types-JzOYvsm9.js";import{C as w}from"./Card-CJMmiDPP.js";import{B as y}from"./Button-Cyrp6Nfh.js";import{P as S}from"./PageLayout-Dlj7iBUq.js";function U(){const{isAuthenticated:n,refreshUser:o}=E(),[t,e]=i.useState({firstName:"",lastName:"",ssn:""}),[g,d]=i.useState(!0),[h,s]=i.useState(!1),[c,m]=i.useState(null),r=i.useCallback(async()=>{d(!0),m(null);try{if(!n){d(!1);return}const f=await j("/user/me");e({firstName:f.firstName??"",lastName:f.lastName??"",ssn:f.ssn??""})}catch(f){m(x(f,"Klarte ikke å hente brukerdata."))}finally{d(!1)}},[n]);i.useEffect(()=>{r()},[r]);const a=i.useCallback(async f=>{const u={firstName:f.firstName.trim(),lastName:f.lastName.trim(),ssn:f.ssn.trim()};if(!u.firstName||!u.lastName||!u.ssn)throw new k("Fyll inn alle feltene før du lagrer.",400);s(!0),m(null);try{await j("/user/me",{method:"PUT",body:u}),e(u),await o()}catch(b){throw m(x(b,"Kunne ikke lagre informasjon.")),b}finally{s(!1)}},[o]),p=i.useMemo(()=>!t.firstName.trim()||!t.lastName.trim()||!t.ssn.trim(),[t.firstName,t.lastName,t.ssn]);return{profile:t,isLoading:g,isSaving:h,error:c,needsInfo:p,saveProfile:a,refresh:r}}function A(n){const t=(n.headers.get("Content-Disposition")??"").match(/filename\*=UTF-8''(.+)|filename="?([^";]+)"?/i);if(!t)return"insurance_request.xml";const[,e,g]=t;if(e)try{return decodeURIComponent(e)}catch{return e}return g??"insurance_request.xml"}function T(n,o){const t=window.URL.createObjectURL(n),e=document.createElement("a");e.href=t,e.download=o,document.body.appendChild(e),e.click(),e.remove(),window.URL.revokeObjectURL(t)}function R(){const{isAuthenticated:n,token:o}=E(),[t,e]=i.useState(!1),[g,d]=i.useState(null),h=i.useCallback(async()=>{if(!n||!o)throw new k("Du må være innlogget for å sende søknaden.",401);e(!0),d(null);try{const s=await fetch(`${I}/insurance/send`,{method:"POST",headers:{Authorization:`Bearer ${o}`}});if(!s.ok){let r=`Request failed with status ${s.status}`;try{const a=await s.json();a&&typeof a=="object"&&"message"in a&&typeof a.message=="string"&&(r=a.message)}catch{try{const a=await s.text();a&&(r=a)}catch{}}throw new k(r,s.status)}const c=await s.blob(),m=A(s);return T(c,m),"Forsikringssøknad generert og lastet ned."}catch(s){const c=x(s);throw d(c),s instanceof Error?s:new k(c,500)}finally{e(!1)}},[n,o]);return{isSending:t,error:g,sendInsurance:h}}const B=P({firstName:N().min(1,"Fornavn er påkrevd"),lastName:N().min(1,"Etternavn er påkrevd"),ssn:N().regex(/^\d{11}$/,"Fødselsnummer må være 11 siffer")});function M(){const{profile:n,isLoading:o,isSaving:t,error:e,needsInfo:g,saveProfile:d}=U(),{isSending:h,error:s,sendInsurance:c}=R(),[m,r]=i.useState(null),a=F({resolver:C(B),defaultValues:{firstName:n.firstName,lastName:n.lastName,ssn:n.ssn},mode:"onTouched"});i.useEffect(()=>{a.reset({firstName:n.firstName,lastName:n.lastName,ssn:n.ssn})},[a,n]),i.useEffect(()=>{e&&r({variant:"error",message:e})},[e]),i.useEffect(()=>{s&&r({variant:"error",message:s})},[s]);const p=i.useMemo(()=>a.handleSubmit(async u=>{r(null);try{await d(u),r({variant:"success",message:"Informasjon lagret. Du kan nå sende søknaden."})}catch(b){r({variant:"error",message:x(b,"Klarte ikke å lagre informasjon. Prøv igjen.")})}}),[a,d]),f=i.useCallback(async()=>{r(null);try{const u=await c();r({variant:"success",message:u})}catch(u){r({variant:"error",message:x(u,"Kunne ikke generere forsikringssøknad.")})}},[c]);return{form:a,banner:m,isLoading:o,isSaving:t,isSending:h,needsInfo:g,onSaveProfile:p,onSendInsurance:f}}function O(){var r,a,p;const{form:n,banner:o,isLoading:t,isSaving:e,isSending:g,needsInfo:d,onSaveProfile:h,onSendInsurance:s}=M(),{register:c,formState:{errors:m}}=n;return t?l.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Henter informasjon ...",maxWidthClassName:"max-w-4xl",children:l.jsx("div",{className:"text-center text-slate-700",children:"Laster ..."})}):l.jsx(S,{title:"Inntektstapsforsikring",subtitle:"Send inn opplysningene dine og få beregnet dekningen som passer planen din.",maxWidthClassName:"max-w-4xl",actions:l.jsx(y,{to:"/plan",className:"bg-white text-emerald-700 border-emerald-200 hover:bg-emerald-50 font-semibold",children:"Tilbake til plan"}),children:l.jsxs("div",{className:"space-y-6",children:[o&&l.jsx(L,{variant:o.variant,message:o.message,action:o.action}),d&&l.jsxs(w,{title:"Fyll ut manglende opplysninger",children:[l.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"For å sende inn forsikringssøkaden må vi vite hvem du er."}),l.jsxs("form",{onSubmit:h,className:"flex flex-col gap-4",children:[l.jsx(v,{label:"Fornavn",placeholder:"Fornavn",error:(r=m.firstName)==null?void 0:r.message,autoComplete:"given-name",...c("firstName")}),l.jsx(v,{label:"Etternavn",placeholder:"Etternavn",error:(a=m.lastName)==null?void 0:a.message,autoComplete:"family-name",...c("lastName")}),l.jsx(v,{label:"Fødselsnummer",placeholder:"Fødselsnummer (11 siffer)",error:(p=m.ssn)==null?void 0:p.message,inputMode:"numeric",autoComplete:"off",...c("ssn")}),l.jsx(y,{type:"submit",disabled:e,children:e?"Lagrer...":"Lagre informasjon"})]})]}),l.jsxs(w,{title:"Send inn søknad",children:[l.jsx("p",{className:"text-sm text-slate-700 mb-4",children:"Vi bruker planen din og opplysningene over til å beregne dekning. Når du sender inn, får du bekreftelse på e-post."}),l.jsx(y,{type:"button",onClick:s,disabled:g,children:g?"Sender...":"Send søknad"})]})]})})}export{O as default};
